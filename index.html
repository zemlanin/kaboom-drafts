<!DOCTYPE html>
<html>
<head>
  <title>kaboom</title>
  <style type="text/css">
    * { font-family: monospace }
    blockquote { background-color: #d3d3d3 }
  </style>
</head>
<body>
  <button id="that-one" data-bazooka="boom clicker"
    data-do-json='
      [["trigger", "clicker/click", ["e"],
          ["clicker/bam", ["get", "e", ":target"]],
          ["log", ["get", "e", ":target"]]],
        ["##", "->",
          ["attr", "#@", "innerText"],
          ["log", "#_"]]]
  '>
    lol
  </button>
  <blockquote data-bazooka="display" data-display="#that-one"></blockquote>
  <div id="other" data-bazooka="clicker">
    wat
  </div>
  <blockquote data-bazooka="display" data-display="#other"></blockquote>
  <hr/>
    <a href="https://github.com/zemlanin/kaboom-drafts">repo</a>
  <script type="text/javascript" src="./bazooka.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
  <script type="text/javascript">
    'use strict'
    var boom, clicker, display

    var boomFuncs = {
      _call: function (args, bindings) {
        if (args.length === 0) {
          return null
        }

        return boomFuncs
          ._resolve(args[0], bindings)
          .apply(
            null,
            _.map(
              args.splice(1),
              function (arg) { return boomFuncs._resolve(arg, bindings) }
            )
          )
      },
      _resolve: function (expr, bindings) {
        if (_.isArray(expr)) {
          return boomFuncs._call(expr, bindings)
        }

        if (expr.startsWith && expr.startsWith(':')) {
          return expr.replace(/^:/, '')
        }

        if (expr.split && expr.split('/').length == 2) {
          return ((bindings || {})[expr.split('/')[0]] || {})[expr.split('/')[1]]
        }

        return (bindings || {})[expr] || boomFuncs[expr] || null
      },
      log: console.log.bind(console),
      get: function (obj, key) { return obj[key] },
      "##": _.noop, // comments
    }

    var boomHandle = function (csp, data) {
      return _.each(
        csp,
        function (l) { boomFuncs._resolve(_.cloneDeep(l), {e: data, clicker: clicker}) }
      )
    }

    boom = {
      bazFunc: function (node) {
        var doJSON = JSON.parse(node.getAttribute('data-do-json'))

        for (var i = 0; i < doJSON.length; i++) {
          if (doJSON[i][0] === 'trigger') {
            _.chain(Baz(node).getComponents())
              .find(function (c, name) {
                return _.some(c.events, function (evHandler, evName) {
                  return doJSON[i][1] === name + '/' + evName || doJSON[i][1] === evName
                })
              })
              .get('events.' + doJSON[i][1].replace(/^[a-zA-Z0-9]+\//i, ''), _.noop)
              .value()(node, boomHandle.bind(null, doJSON[i].slice(3)))
          }
        }

        doJSON = null
      },
    }

    // ===================================

    clicker = {
      bazFunc: function (node) {},
      events: {
        'click': function (node, pub) { node.onclick = pub }
      },
      "bam": function (node) {
        console.log("BAM")
        if (node.getAttribute('style')) {
          node.removeAttribute('style')
        } else {
          node.setAttribute('style', 'background-color: black; color: white')
        }
      }
    }

    display = function (node) {
      var displayedNode = document.querySelector(node.dataset.display)

      if (displayedNode) {
        node.innerText = displayedNode.outerHTML
          .replace(/^  /gm, '')
          .replace(/&quot;/g, "'")
          .replace(/ (?![^ ])/gm, "â€ƒ") // not a space http://www.fileformat.info/info/unicode/char/2003/index.htm
      }
    }

    Baz.register({
      boom: boom,
      clicker: clicker,
      display: display,
    })

    Baz.refresh()
  </script>
</body>
</html>
