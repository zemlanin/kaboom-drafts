<!DOCTYPE html>
<html>
<head>
  <title>kaboom</title>
  <style type="text/css">
    * { font-family: monospace }
    pre { background-color: #d3d3d3 }
  </style>
</head>
<body>
  <button id="that-one" data-bazooka="boom clicker"
    data-do='
      [["hear", "clicker/click", ["e"],
          ["clicker/toggle", ["get", "e", ":target"]],
          ["log", [":target", "e"]]],
        // comment
        ["function-not-found"]]
  '>
    lol
  </button>
  <pre data-bazooka="display" data-display="#that-one"></pre>
  <hr/>
  <a href="https://github.com/zemlanin/kaboom-drafts">repo</a>
  <script type="text/javascript" src="./bazooka.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
  <script type="text/javascript">
    'use strict'
    var macros = {hear: 1, '##': 1, call: 1, resolve: 1}

    var baseFn = function (bindings, bindingNames, funcs) {
      return function () {
        var result, bs = _.cloneDeep(bindings)

        for (var i = 0; i < bindingNames.length; i++) {
          bs[bindingNames[i]] = arguments[i]
        }
        for (var j = 0; j < funcs.length; j++) {
          result = boomFuncs.resolve(bs, _.cloneDeep(funcs[j]))
        }

        bs = null
        return result
      }
    }

    var boomFuncs = {
      "string?": function (expr) {
        return expr != null && !!expr.startsWith && expr.startsWith(':')
      },
      string: function (expr) {
        if (boomFuncs["string?"](expr)) {
          return expr.replace(/^:/, '')
        }
        return expr
      },
      "function?": function (expr) {
        return !!expr && !!expr.apply
      },
      call: function (bindings, args) {
        var func
        if (args.length === 0) { return null }

        if (boomFuncs["string?"](args[0])) {
          func = function (obj) { return boomFuncs.get(obj, boomFuncs["string"](args[0])) }
        } else if (boomFuncs["function?"](args[0])) {
          func = args[0]
        } else {
          func = boomFuncs.resolve(bindings, args[0])
        }

        if (!boomFuncs["function?"](func)) {
          console.error(
            'function `%s` is not found in current namespace %o\n%s',
            args[0], bindings,
            bindings.node.getAttribute('data-do').replace(/^\n|\n\s*$/g, '')
          )

          return null
        }

        return func.apply(
          null,
          macros[args[0]] ? [bindings].concat(args.splice(1)) : _.map(
            args.splice(1),
            boomFuncs.resolve.bind(this, _.cloneDeep(bindings))
          )
        )
      },
      resolve: function (bindings, expr) {
        if (_.isArray(expr)) { return boomFuncs.call(bindings, expr) }

        if (boomFuncs["string?"](expr)) { return boomFuncs["string"](expr) }

        if (expr.split) {
          if (expr.split('/').length == 2) {
            return ((bindings || {})[expr.split('/')[0]] || {})[expr.split('/')[1]]
          } else if (expr.split('/').length > 2) {
            throw new Error('Too many slashes', expr)
          }
        }

        return (bindings || {})[expr] || boomFuncs[expr] || null
      },
      log: console.log.bind(console),
      get: function (obj, key) { return obj[key] },
      hear: function (bindings, evSymbol, bindingNames) {
        return bindings[evSymbol.split('/')[0]].events[evSymbol.split('/')[1]](
          bindings.node,
          baseFn(bindings, bindingNames, Array.prototype.splice.call(arguments, 3))
        )
      }
    }

    var boom = {
      bazFunc: function (node) {
        var doJSON = JSON.parse(node.getAttribute('data-do').replace(/^\s*\/\/.*$/gm, ''))
        var bindings = _.merge(Baz(node).getComponents(), {node: node})

        for (var i = 0; i < doJSON.length; i++) {
          boomFuncs.resolve(bindings, doJSON[i])
        }

        doJSON = null
        bindings = null
      },
    }

    // ===================================

    var clicker, display

    clicker = {
      bazFunc: function (node) {},
      events: {
        click: function (node, pub) { node.onclick = pub }
      },
      toggle: function (node) {
        if (node.getAttribute('style')) {
          node.removeAttribute('style')
        } else {
          node.setAttribute('style', 'background-color: black; color: white')
        }
      }
    }

    display = function (node) {
      var displayedNode = document.querySelector(node.dataset.display)

      if (displayedNode) {
        node.innerText = displayedNode.outerHTML.replace(/^  /gm, '').replace(/&quot;/g, "\"")
      }
    }

    Baz.register({
      boom: boom,
      clicker: clicker,
      display: display,
    })

    Baz.refresh()
  </script>
</body>
</html>
